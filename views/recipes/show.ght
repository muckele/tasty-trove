<section class="reviews">
  <h2>Reviews</h2>
  <% if (user) { %>
    <form 
      id="add-review-form"
      action="/recipes/<%= recipe._id %>/reviews"
      method="POST"
      placeholder="Rate your recipe!"
    >
      <textarea name="content" id="content-textarea"></textarea>
      <label for="rating-select">Rating:</label>
      <select name="rating" id="rating-select">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5" selected>5</option>
      </select>
      <button type="submit" class="btn">Add Review</button>
    </form>
  <% } else { %>
    <p>Please log in to leave a review.</p>
  <% } %>

  <% if (recipe.reviews.length) { %>
    <table>
      <thead>
        <tr>
          <th>Review</th>
          <th>Reviewer</th>
          <th>Rating</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% let total = 0 %>
        <% recipe.reviews.forEach(function(review) { %>
          <tr>
            <td><%= review.content %></td>
            <td><%= review.author.name %></td>
            <td><%= review.rating %></td>
            <td><%= review.createdAt.toLocaleDateString() %></td>
            <td>
              <% if (review.author.equals(user?.profile._id)) { %>
                <form action="/recipes/<%= recipe._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
                  <button class="btn edit-btn">🗑️</button>
                </form>
                <a href="/recipes/<%= recipe._id %>/reviews/<%= review._id %>/edit">
                  <button class="btn edit-btn">📝</button>
                </a>
              <% } %>
            </td>
          </tr>

          <% total += review.rating %>
        <% }) %>
        <span class="average-rating">
          <td colspan="3">Average Rating:</td>
          <td><%= (recipe.reviews.length > 0) ? (total / recipe.reviews.length).toFixed(2) : 'N/A' %></td>
        </span>
      </tbody>
    </table>
  <% } else { %>
    <p id="leave-review">No reviews yet. Be the first to leave a review!</p>
  <% } %>
</section>